<UserControl
    x:Class="IRExplorerUI.Profile.FlameGraphHost"
    xmlns="http://schemas.microsoft.com/winfx/2006/xaml/presentation"
    xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
    xmlns:controls="clr-namespace:IRExplorerUI.Controls"
    xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
    xmlns:irExplorerUi="clr-namespace:IRExplorerUI"
    xmlns:local="clr-namespace:IRExplorerUI.Profile"
    xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
    d:DesignHeight="450"
    d:DesignWidth="800"
    mc:Ignorable="d">
    <UserControl.CommandBindings>
        <CommandBinding Command="irExplorerUi:GraphCommand.GraphZoomIn" Executed="ExecuteGraphZoomIn" />
        <CommandBinding Command="irExplorerUi:GraphCommand.GraphZoomOut" Executed="ExecuteGraphZoomOut" />
        <CommandBinding Command="local:CallTreeCommand.SelectFunction" Executed="SelectFunctionExecuted" />
        <CommandBinding Command="local:CallTreeCommand.OpenFunction" Executed="OpenFunctionExecuted" />
        <CommandBinding Command="local:CallTreeCommand.OpenFunctionInNewTab" Executed="OpenFunctionInNewTab" />
        <CommandBinding Command="local:CallTreeCommand.PreviousSearchResult" Executed="PreviousSearchResultExecuted" />
        <CommandBinding Command="local:CallTreeCommand.NextSearchResult" Executed="NextSearchResultExecuted" />
        <CommandBinding Command="local:CallTreeCommand.EnlargeNode" Executed="EnlargeNodeExecuted" />
        <CommandBinding Command="local:CallTreeCommand.ChangeRootNode" Executed="ChangeRootNodeExecuted" />
        <CommandBinding Command="local:CallTreeCommand.MarkAllInstances" Executed="MarkAllInstancesExecuted" />
        <CommandBinding Command="local:CallTreeCommand.ClearMarkedNodes" Executed="ClearMarkedNodesExecuted" />
    </UserControl.CommandBindings>

    <UserControl.InputBindings>
        <KeyBinding
            Key="R"
            Command="irExplorerUi:GraphCommand.GraphResetWidth"
            CommandTarget="{Binding ElementName=GraphHost}"
            Modifiers="Ctrl" />
        <KeyBinding
            Key="F3"
            Command="local:CallTreeCommand.PreviousSearchResult"
            Modifiers="Shift" />
        <KeyBinding Key="F3" Command="local:CallTreeCommand.NextSearchResult" />
    </UserControl.InputBindings>

    <irExplorerUi:ScrollViewerClickable
        x:Name="GraphHost"
        Background="{DynamicResource {x:Static SystemColors.ControlBrushKey}}"
        HorizontalScrollBarVisibility="Auto"
        ScrollChanged="GraphHost_OnScrollChanged"
        VerticalScrollBarVisibility="Auto">
        <local:FlameGraphViewer x:Name="GraphViewer">
            <local:FlameGraphViewer.ContextMenu>
                <ContextMenu>
                    <MenuItem
                        Command="local:CallTreeCommand.EnlargeNode"
                        CommandTarget="{Binding Path=PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                        Header="Focus on Function"
                        InputGestureText="Double-click"
                        ToolTip="Enlarge the function in the view" />
                    <MenuItem
                        Command="local:CallTreeCommand.ChangeRootNode"
                        CommandTarget="{Binding Path=PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                        Header="Set Function as Root"
                        InputGestureText="Alt+Double-click"
                        ToolTip="Restrict the view to the function and its callees" />
                    <Separator />
                    <MenuItem
                        Command="local:CallTreeCommand.SelectFunction"
                        CommandTarget="{Binding Path=PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                        Header="Select Function"
                        InputGestureText="Return"
                        ToolTip="Select function in the Summary panel" />
                    <MenuItem
                        Command="local:CallTreeCommand.OpenFunction"
                        CommandTarget="{Binding Path=PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                        Header="Open Function"
                        InputGestureText="Ctrl+Return"
                        ToolTip="Open the function ASM view" />
                    <MenuItem
                        Command="local:CallTreeCommand.OpenFunctionInNewTab"
                        CommandTarget="{Binding Path=PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                        Header="Open Function in New Tab"
                        InputGestureText="Ctrl+Shift+Return"
                        ToolTip="Open the function ASM view in a new tab" />
                    <Separator />
                    <MenuItem
                        Command="local:CallTreeCommand.MarkAllInstances"
                        CommandTarget="{Binding Path=PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                        Header="Mark Function Instances"
                        ToolTip="Mark all instances of the function" />
                    <MenuItem
                        Command="local:CallTreeCommand.ClearMarkedNodes"
                        CommandTarget="{Binding Path=PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                        Header="Clear Marked Functions"
                        ToolTip="Clear all marked functions" />
                    <MenuItem
                        Command="irExplorerUi:GraphCommand.GraphZoomOut"
                        CommandTarget="{Binding Path=PlacementTarget, RelativeSource={RelativeSource AncestorType=ContextMenu}}"
                        Header="Select Function in Call Tree"
                        IsEnabled="False"
                        ToolTip="Select the function instance in the Call Tree panel" />
                </ContextMenu>
            </local:FlameGraphViewer.ContextMenu>
        </local:FlameGraphViewer>
    </irExplorerUi:ScrollViewerClickable>
</UserControl>